<?php
// panier.php ‚Äî affiche le contenu du panier
session_start();
require __DIR__ . '/bd.php';
$pdo = getBD();

function e($v){ return htmlspecialchars((string)$v, ENT_QUOTES, 'UTF-8'); }

$panier = $_SESSION['panier'] ?? [];

// R√©cup√©rer les articles
$rows = [];
$total = 0.0;

if ($panier) {
  foreach ($panier as $item) {
    $id  = (int)($item['id_art'] ?? 0);
    $qte = (int)($item['quantite'] ?? 0);
    if ($id <= 0 || $qte <= 0) { continue; }

    $stmt = $pdo->prepare('SELECT id_art, nom, prix FROM Articles WHERE id_art = :id LIMIT 1');
    $stmt->execute([':id' => $id]);
    if ($a = $stmt->fetch(PDO::FETCH_ASSOC)) {
      $ligne_total = (float)$a['prix'] * $qte;
      $total += $ligne_total;
      $rows[] = [
        'id_art' => $a['id_art'],
        'nom'    => $a['nom'],
        'prix'   => (float)$a['prix'],
        'qte'    => $qte,
        'sous_total' => $ligne_total,
      ];
    }
  }
}
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>SHAMTEK ‚Äî Mon panier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <header>
    <div class="container header-row">
      <div class="logo">
        <a href="index.php"><img src="images/logo.svg" alt="SHAMTEK" class="logo-img"></a>
      </div>
      <div class="login-icon">
        <?php if (!isset($_SESSION['client'])): ?>
          <a href="nouveau.php" class="header-link">
            <img src="images/login.svg" alt="" class="icon-login">
            <span class="login-text"> Nouveau Client </span>
          </a>
          <a href="connexion.php" class="header-link" style="margin-left:12px">
            <img src="images/login.svg" alt="" class="icon-login">
            <span class="login-text"> Se connecter </span>
          </a>
        <?php else: ?>
          <span class="login-text" style="margin-right:12px;">
            Bonjour <?= e($_SESSION['client']['prenom'].' '.$_SESSION['client']['nom']); ?>
          </span>
          <a href="deconnexion.php" class="header-link">‚éã Se d√©connecter</a>
        <?php endif; ?>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="panel">
      <div class="panel-body">
        <h1 class="h1">Votre panier</h1>

        <?php if (!$rows): ?>
          <p>Votre panier ne contient aucun article.</p>
        <?php else: ?>
          <div class="table-wrap" style="overflow:auto;">
            <table class="table" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">ID</th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">Nom</th>
                  <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Prix (‚Ç¨)</th>
                  <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Quantit√©</th>
                  <th style="text-align:right; padding:8px; border-bottom:1px solid #e5e7eb;">Sous-total (‚Ç¨)</th>
                </tr>
              </thead>
              <tbody>
                <?php foreach ($rows as $r): ?>
                  <tr>
                    <td style="padding:8px; border-bottom:1px solid #f3f4f6;"><?= (int)$r['id_art'] ?></td>
                    <td style="padding:8px; border-bottom:1px solid #f3f4f6;"><?= e($r['nom']) ?></td>
                    <td style="padding:8px; text-align:right; border-bottom:1px solid #f3f4f6;"><?= number_format($r['prix'], 2, ',', ' ') ?></td>
                    <td style="padding:8px; text-align:right; border-bottom:1px solid #f3f4f6;"><?= (int)$r['qte'] ?></td>
                    <td style="padding:8px; text-align:right; border-bottom:1px solid #f3f4f6;"><?= number_format($r['sous_total'], 2, ',', ' ') ?></td>
                  </tr>
                <?php endforeach; ?>
                <tr>
                  <td colspan="4" style="padding:12px; text-align:right; font-weight:700;">Total</td>
                  <td style="padding:12px; text-align:right; font-weight:700;"><?= number_format($total, 2, ',', ' ') ?> ‚Ç¨</td>
                </tr>
              </tbody>
            </table>
          </div>
        <?php endif; ?>

        <div style="margin-top:12px;">
          <a href="index.php" class="back">‚Üê Retour</a>
        </div>
      </div>
    </div>
  </main>

  <!-- üîπ FOOTER -->
<footer>
  <div class="container foot">
    <span>¬© <?= date('Y') ?> SHAMTEK</span>
    <span><a href="contact.php" class="footer-link">Contact</a></span>
  </div>
</footer>


</body>
</html>
