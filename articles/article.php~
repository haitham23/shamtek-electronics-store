<?php
session_start();
require __DIR__ . '/../bd.php';
$pdo = getBD();

// جلب المقال عبر id_art من GET
$id = filter_input(INPUT_GET, 'id_art', FILTER_VALIDATE_INT);
if (!$id || $id <= 0) { http_response_code(400); exit('Requête invalide.'); }

$stmt = $pdo->prepare('SELECT id_art, nom, quantite, prix, url_photo, description FROM Articles WHERE id_art = ?');
$stmt->execute([$id]);
$article = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$article) { http_response_code(404); exit('Article introuvable.'); }

// مسار الصورة
$imgRel = trim((string)$article['url_photo']);

function e($v){ return htmlspecialchars((string)$v, ENT_QUOTES, 'UTF-8'); }
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title><?= e($article['nom']) ?> — SHAMTEK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../style.css">
</head>
<body>

<?php require '../header.php'; ?>

  <!-- MAIN -->
  <main class="container">
    <div class="product">
      <div class="panel">
        <?php if ($imgRel !== ''): ?>
          <img src="../<?= e($imgRel) ?>" alt="Image de l'article" class="thumb">
        <?php else: ?>
          <div class="panel-body">Aucune image.</div>
        <?php endif; ?>
      </div>

      <div class="panel panel-body">
        <h1 class="h1"><?= e($article['nom']) ?></h1>

        <div class="badges">
          <span class="badge">Réf #<?= (int)$article['id_art'] ?></span>
          <span class="badge">Qté <?= (int)$article['quantite'] ?></span>
        </div>

        <div class="px"><?= number_format((float)$article['prix'], 2, ',', ' ') ?> €</div>

        <div class="desc"><?= nl2br(e($article['description'])) ?></div>

        <!-- ADD TO CART -->
        <?php if (isset($_SESSION['id_client'])): ?>

          <?php if ((int)$article['quantite'] > 0): ?>
            <form action="../ajouter.php" method="post" style="margin-top:16px;">
              <input type="hidden" name="id_art" value="<?= (int)$article['id_art'] ?>">
              <label class="panel-body" style="padding:0 0 8px 0; max-width:260px;">
                <span style="display:block; font-weight:600; margin-bottom:6px;">Quantité</span>
                <input type="number" name="qte" min="1" max="<?= (int)$article['quantite'] ?>" value="1"
                       style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px;">
              </label>

              <input type="submit" class="btn" value="Ajouter à votre panier">
            </form>
          <?php else: ?>
            <div class="badge">Rupture de stock</div>
          <?php endif; ?>

        <?php else: ?>

          <div class="alert" style="margin-top:12px;">Connectez-vous pour ajouter au panier.</div>
          <a href="../connexion.php" class="btn">Se connecter</a>

        <?php endif; ?>

        <div style="margin-top:12px;">
          <a href="../index.php" class="back">← Retour</a>
        </div>

      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="container foot">
      <span>© <?= date('Y') ?> SHAMTEK</span>
      <span><a href="../contact.php" class="footer-link">Contact</a></span>
    </div>
  </footer>

</body>
</html>
