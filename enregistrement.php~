<?php
// enregistrement.php — validation + insertion BD (POST) avec password_hash
require __DIR__ . '/bd.php';

// Lire strictement depuis POST
$n    = trim($_POST['n']    ?? '');
$p    = trim($_POST['p']    ?? '');
$adr  = trim($_POST['adr']  ?? '');
$num  = trim($_POST['num']  ?? '');
$mail = trim($_POST['mail'] ?? '');
$mdp1 = $_POST['mdp1']      ?? '';
$mdp2 = $_POST['mdp2']      ?? '';

// Aides redirection
function redirect_back($n, $p, $adr, $num, $mail) {
    $params = http_build_query([
        'n'   => $n,
        'p'   => $p,
        'adr' => $adr,
        'num' => $num,
        'mail'=> $mail
    ]);
    $url = 'nouveau.php' . ($params ? ('?' . $params) : '');
    echo '<!doctype html><html><head><meta charset="utf-8">';
    echo '<meta http-equiv="refresh" content="0;url=' . htmlspecialchars($url, ENT_QUOTES, 'UTF-8') . '">';
    echo '<title>Redirection...</title></head><body>Redirection...</body></html>';
    exit;
}
function redirect_home() {
    echo '<!doctype html><html><head><meta charset="utf-8">';
    echo '<meta http-equiv="refresh" content="0;url=index.php">';
    echo '<title>Succès</title></head><body>Succès, redirection...</body></html>';
    exit;
}

// Validation minimale
$invalid = (
    $n === '' || $p === '' || $adr === '' || $num === '' || $mail === '' || $mdp1 === '' || $mdp2 === '' ||
    $mdp1 !== $mdp2
);
if ($invalid) {
    redirect_back($n, $p, $adr, $num, $mail);
}

// Hash sécurisé du mot de passe
$mdp_hash = password_hash($mdp1, PASSWORD_DEFAULT);

// Insertion BD (colonne 'mdp' stocke maintenant le hash)
try {
    $pdo = getBD();
    $sql = 'INSERT INTO Clients (nom, prenom, adresse, numero, mail, mdp)
            VALUES (:nom, :prenom, :adresse, :numero, :mail, :mdp)';
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        ':nom'     => $n,
        ':prenom'  => $p,
        ':adresse' => $adr,
        ':numero'  => $num,
        ':mail'    => $mail,
        ':mdp'     => $mdp_hash,
    ]);
    redirect_home();
} catch (Throwable $e) {
    // En cas d'erreur on revient au formulaire sans exposer l'erreur
    redirect_back($n, $p, $adr, $num, $mail);
}
